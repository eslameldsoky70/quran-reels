<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙˆÙ„Ù‘Ø¯ Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Scheherazade+New:wght@400;700&family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#080d12;--s1:#0f1822;--s2:#162030;--s3:#1c2a3e;--gold:#c9a84c;--gold2:#e8c97a;--gold3:rgba(201,168,76,.13);--green:#2d6a4f;--green2:#52b788;--text:#e2ddd0;--dim:#6e6455;--border:rgba(201,168,76,.18);--r:14px}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;direction:rtl;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 80% 50% at 15% 8%,rgba(45,106,79,.13) 0%,transparent 55%),radial-gradient(ellipse 60% 50% at 85% 92%,rgba(201,168,76,.07) 0%,transparent 55%)}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(201,168,76,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(201,168,76,.03) 1px,transparent 1px);background-size:55px 55px}
.wrap{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:0 20px 80px}
header{text-align:center;padding:48px 0 36px}
.orn{font-size:1.8rem;color:var(--gold);letter-spacing:10px;display:block;margin-bottom:12px;opacity:.7}
header h1{font-family:'Amiri',serif;font-size:clamp(2rem,5vw,3.2rem);color:var(--gold2);margin-bottom:8px}
header p{color:var(--dim);font-size:.92rem}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:26px 0;opacity:.3}
.grid{display:grid;grid-template-columns:1fr 370px;gap:22px;align-items:start}
@media(max-width:850px){.grid{grid-template-columns:1fr}}
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:24px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;right:0;width:80px;height:80px;background:radial-gradient(circle,var(--gold3) 0%,transparent 70%);transform:translate(20px,-20px)}
.ct{font-family:'Amiri',serif;font-size:1.1rem;color:var(--gold);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--s2);padding:4px;border-radius:12px}
.tab{flex:1;padding:9px 4px;text-align:center;border-radius:9px;cursor:pointer;font-size:.8rem;color:var(--dim);transition:all .2s;border:none;background:none;font-family:'Tajawal',sans-serif}
.tab.active{background:var(--s1);color:var(--gold);font-weight:700}
.tp{display:none}.tp.active{display:block;animation:fi .3s ease}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
label{display:block;font-size:.8rem;color:var(--dim);margin-bottom:6px;font-weight:500}
input,select,textarea{width:100%;background:var(--s2);border:1px solid rgba(201,168,76,.2);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'Tajawal',sans-serif;font-size:.9rem;direction:rtl;transition:border-color .2s;outline:none;margin-bottom:14px;-webkit-appearance:none}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%23c9a84c' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:left 12px center;padding-left:32px}
input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.1)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.rg{margin-bottom:14px}
.rg-top{display:flex;justify-content:space-between;margin-bottom:7px}
.rv{color:var(--gold);font-size:.8rem;font-weight:700}
input[type=range]{-webkit-appearance:none;height:4px;background:linear-gradient(90deg,var(--gold) var(--pct,50%),var(--s3) var(--pct,50%));border-radius:2px;padding:0;margin-bottom:0;border:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--gold);border-radius:50%;box-shadow:0 0 8px rgba(201,168,76,.5)}
.tog{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(201,168,76,.07)}
.tog:last-child{border-bottom:none}
.tl{font-size:.87rem}.ts{font-size:.7rem;color:var(--dim);margin-top:2px}
.sw{position:relative;width:44px;height:24px;flex-shrink:0}
.sw input{opacity:0;width:0;height:0}
.sli{position:absolute;inset:0;background:var(--s3);border:1px solid var(--border);border-radius:24px;cursor:pointer;transition:.3s}
.sli::before{content:'';position:absolute;width:16px;height:16px;right:4px;top:3px;background:var(--dim);border-radius:50%;transition:.3s}
input:checked+.sli{background:var(--green);border-color:var(--green2)}
input:checked+.sli::before{right:22px;background:#fff}
.fp{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;margin-bottom:14px;min-height:58px;display:flex;align-items:center;justify-content:center}
.fp p{font-size:1.4rem;color:var(--gold2);line-height:1.7}
.palette{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.col{width:30px;height:30px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .2s;position:relative;flex-shrink:0}
.col:hover{transform:scale(1.15)}
.col.active{border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,.3)}
.col.active::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.65rem}
.eff-g{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px}
.eff{padding:9px 6px;background:var(--s2);border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all .2s;font-size:.68rem;color:var(--dim)}
.eff:hover,.eff.active{border-color:var(--gold)}
.eff.active{background:var(--gold3);color:var(--gold)}
.eff em{font-size:1rem;display:block;margin-bottom:3px;font-style:normal}
.rec-g{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.rec{padding:9px 7px;background:var(--s2);border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all .2s;font-size:.76rem;color:var(--dim)}
.rec:hover,.rec.active{border-color:var(--gold)}
.rec.active{background:var(--gold3);color:var(--gold);font-weight:700}
.rec small{font-size:.58rem;display:block;margin-top:2px;opacity:.7}
.phone{background:#060a0d;border:3px solid #222;border-radius:38px;padding:10px;max-width:220px;margin:0 auto 16px;box-shadow:0 0 0 1px #111,0 20px 50px rgba(0,0,0,.8)}
.notch{width:70px;height:18px;background:#060a0d;border-radius:0 0 12px 12px;margin:0 auto 6px}
.screen{background:#0a0f14;border-radius:26px;overflow:hidden;aspect-ratio:9/16;position:relative}
#pvc{width:100%;height:100%;display:block}
.wvs{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:2px;align-items:center}
.wb{width:2px;background:var(--gold);border-radius:1px;animation:wav 1.2s ease-in-out infinite}
.wb:nth-child(1){height:5px;animation-delay:0s}.wb:nth-child(2){height:10px;animation-delay:.1s}.wb:nth-child(3){height:16px;animation-delay:.2s}.wb:nth-child(4){height:8px;animation-delay:.3s}.wb:nth-child(5){height:13px;animation-delay:.4s}.wb:nth-child(6){height:6px;animation-delay:.5s}.wb:nth-child(7){height:11px;animation-delay:.6s}
@keyframes wav{0%,100%{transform:scaleY(.4);opacity:.4}50%{transform:scaleY(1);opacity:1}}
.pw{background:var(--s2);border-radius:8px;height:7px;overflow:hidden;margin-bottom:10px;display:none}
.pb{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));width:0%;transition:width .3s;border-radius:8px}
.st{text-align:center;font-size:.77rem;color:var(--dim);margin-bottom:11px;min-height:18px}
.btn-gen{width:100%;padding:14px;background:linear-gradient(135deg,var(--green),#1b4035);border:1px solid var(--green2);border-radius:12px;color:#fff;font-family:'Tajawal',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-gen:hover{box-shadow:0 8px 28px rgba(45,106,79,.45);transform:translateY(-1px)}
.btn-gen:active,.btn-gen:disabled{transform:none;box-shadow:none}
.btn-gen:disabled{opacity:.45;cursor:not-allowed}
.btn-s{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--dim);font-family:'Tajawal',sans-serif;font-size:.85rem;cursor:pointer;transition:all .3s;margin-top:8px}
.btn-s:hover{border-color:var(--gold);color:var(--gold)}
.dlb{display:none;background:linear-gradient(135deg,rgba(45,106,79,.15),rgba(201,168,76,.07));border:1px solid var(--green2);border-radius:12px;padding:18px;text-align:center;margin-top:14px}
.dlb p{font-size:.85rem;color:var(--green2);margin-bottom:12px;font-weight:600}
.btn-dl{display:inline-flex;align-items:center;gap:8px;padding:11px 24px;background:var(--gold);color:#1a1008;border:none;border-radius:10px;font-family:'Tajawal',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;text-decoration:none;transition:all .2s}
.btn-dl:hover{background:var(--gold2);transform:translateY(-1px)}
.share{font-size:.7rem;color:var(--dim);text-align:center;margin-top:8px}
.log{background:#050d0a;border:1px solid rgba(82,183,136,.18);border-radius:10px;padding:12px;font-size:.7rem;color:#3d6e50;font-family:'Courier New',monospace;direction:ltr;text-align:left;max-height:150px;overflow-y:auto;margin-top:12px;display:none;line-height:2}
.log .ok{color:var(--green2)}.log .er{color:#e05555}.log .in{color:var(--gold)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--s2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
<header>
  <span class="orn">âœ¦ âœ¦ âœ¦</span>
  <h1>Ù…ÙˆÙ„Ù‘Ø¯ Ø±ÙŠÙ„Ø² Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
  <p>ÙÙŠØ¯ÙŠÙˆ 9:16 Ø¨ØµÙˆØª Ø§Ù„ØªÙ„Ø§ÙˆØ© Ù…Ø¯Ù…Ø¬ Â· ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages</p>
</header>
<div class="divider"></div>
<div class="grid">
<div>
  <div class="tabs">
    <button class="tab active" onclick="doTab('content',this)">ğŸ“– Ø§Ù„Ø¢ÙŠØ§Øª</button>
    <button class="tab" onclick="doTab('design',this)">ğŸ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…</button>
    <button class="tab" onclick="doTab('audio',this)">ğŸµ Ø§Ù„ØµÙˆØª</button>
    <button class="tab" onclick="doTab('export',this)">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
  </div>
  <div class="tp active" id="tp-content">
    <div class="card">
      <div class="ct">ğŸ“– Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¢ÙŠØ§Øª</div>
      <label>Ø§Ù„Ø³ÙˆØ±Ø©</label>
      <select id="surah" onchange="onSurah()"><option value="">â€” Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„... â€”</option></select>
      <div class="row2">
        <div><label>Ù…Ù† Ø§Ù„Ø¢ÙŠØ©</label><input type="number" id="af" min="1" value="1" onchange="loadAyahs()"></div>
        <div><label>Ø¥Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ©</label><input type="number" id="at" min="1" value="7" onchange="loadAyahs()"></div>
      </div>
      <label>Ø§Ù„ØªØ±Ø¬Ù…Ø©</label>
      <select id="trans" onchange="loadAyahs()">
        <option value="none">Ø¨Ø¯ÙˆÙ† ØªØ±Ø¬Ù…Ø©</option>
        <option value="en.sahih">English â€” Sahih International</option>
        <option value="fr.hamidullah">FranÃ§ais</option>
        <option value="ur.ahmedali">Ø§Ø±Ø¯Ùˆ</option>
      </select>
      <label>Ù†Øµ Ø§Ù„Ø¢ÙŠØ§Øª</label>
      <textarea id="aytxt" rows="5" readonly style="resize:vertical;opacity:.85" placeholder="Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹..."></textarea>
    </div>
  </div>
  <div class="tp" id="tp-design">
    <div class="card">
      <div class="ct">ğŸ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…</div>
      <label>Ø§Ù„Ø®Ø·</label>
      <select id="fsel" onchange="updFont()">
        <option value="Amiri">Ø§Ù„Ø£Ù…ÙŠØ±ÙŠ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
        <option value="Scheherazade New">Ø´Ù‡Ø±Ø²Ø§Ø¯ Ù†ÙŠÙˆ</option>
        <option value="Reem Kufi">Ø±ÙŠÙ… ÙƒÙˆÙÙŠ</option>
      </select>
      <div class="fp"><p id="fpdemo" style="font-family:'Amiri',serif">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p></div>
      <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
      <div class="palette">
        <div class="col active" style="background:linear-gradient(135deg,#0d2818,#061810)" onclick="doPal(this,'#0d2818','#061810')"></div>
        <div class="col" style="background:linear-gradient(135deg,#1a1a2e,#16213e)" onclick="doPal(this,'#1a1a2e','#16213e')"></div>
        <div class="col" style="background:linear-gradient(135deg,#2c1810,#1a0f08)" onclick="doPal(this,'#2c1810','#1a0f08')"></div>
        <div class="col" style="background:linear-gradient(135deg,#0a0a0a,#181818)" onclick="doPal(this,'#0a0a0a','#181818')"></div>
        <div class="col" style="background:linear-gradient(135deg,#1a0a2e,#120820)" onclick="doPal(this,'#1a0a2e','#120820')"></div>
        <div class="col" style="background:linear-gradient(135deg,#0a1f2e,#060f1e)" onclick="doPal(this,'#0a1f2e','#060f1e')"></div>
      </div>
      <label>Ù…Ø¤Ø«Ø± Ø§Ù„Ø­Ø±ÙƒØ©</label>
      <div class="eff-g">
        <div class="eff active" onclick="doEff(this,'fade')"><em>âœ¨</em>ØªÙ„Ø§Ø´ÙŠ</div>
        <div class="eff" onclick="doEff(this,'slide')"><em>â¬†ï¸</em>Ø§Ù†Ø²Ù„Ø§Ù‚</div>
        <div class="eff" onclick="doEff(this,'zoom')"><em>ğŸ”</em>ØªÙƒØ¨ÙŠØ±</div>
        <div class="eff" onclick="doEff(this,'glow')"><em>ğŸ’«</em>Ù†Ø¨Ø¶</div>
        <div class="eff" onclick="doEff(this,'write')"><em>âœï¸</em>ÙƒØªØ§Ø¨Ø©</div>
        <div class="eff" onclick="doEff(this,'flip')"><em>ğŸŒ€</em>Ø¯ÙˆØ±Ø§Ù†</div>
      </div>
      <div class="rg">
        <div class="rg-top"><label style="margin:0">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label><span class="rv" id="fsv">68</span></div>
        <input type="range" id="fsize" min="36" max="110" value="68" oninput="doRng(this,'fsv','')">
      </div>
      <div class="rg">
        <div class="rg-top"><label style="margin:0">Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø«Ø§Ù†ÙŠØ©)</label><span class="rv" id="durv">30</span></div>
        <input type="range" id="dur" min="10" max="90" value="30" oninput="doRng(this,'durv','')">
      </div>
      <div class="tog"><div><div class="tl">Ø²Ø®Ø§Ø±Ù Ù‡Ù†Ø¯Ø³ÙŠØ©</div></div><label class="sw"><input type="checkbox" id="pat" checked><span class="sli"></span></label></div>
      <div class="tog"><div><div class="tl">Ø§Ù„Ø¨Ø³Ù…Ù„Ø©</div></div><label class="sw"><input type="checkbox" id="bism" checked><span class="sli"></span></label></div>
      <div class="tog"><div><div class="tl">Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø³ÙˆØ±Ø©</div></div><label class="sw"><input type="checkbox" id="ref" checked><span class="sli"></span></label></div>
    </div>
  </div>
  <div class="tp" id="tp-audio">
    <div class="card">
      <div class="ct">ğŸµ Ø§Ù„ØªÙ„Ø§ÙˆØ©</div>
      <label>Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
      <div class="rec-g">
        <div class="rec active" onclick="doRec(this,'ar.alafasy')">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ<small>ar.alafasy</small></div>
        <div class="rec" onclick="doRec(this,'ar.abdurrahmaansudais')">Ø§Ù„Ø³Ø¯ÙŠØ³<small>ar.abdurrahmaansudais</small></div>
        <div class="rec" onclick="doRec(this,'ar.husary')">Ø§Ù„Ø­ØµØ±ÙŠ<small>ar.husary</small></div>
        <div class="rec" onclick="doRec(this,'ar.minshawi')">Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ<small>ar.minshawi</small></div>
        <div class="rec" onclick="doRec(this,'ar.abdulbasitmurattal')">Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø·<small>ar.abdulbasitmurattal</small></div>
        <div class="rec" onclick="doRec(this,'ar.shaatree')">Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ<small>ar.shaatree</small></div>
      </div>
      <div class="rg">
        <div class="rg-top"><label style="margin:0">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª</label><span class="rv" id="volv">90%</span></div>
        <input type="range" id="vol" min="10" max="100" value="90" oninput="doRng(this,'volv','%')">
      </div>
      <!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ÙÙŠ â€” ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <audio id="aud" crossorigin="anonymous" style="display:none"></audio>
    </div>
  </div>
  <div class="tp" id="tp-export">
    <div class="card">
      <div class="ct">ğŸ“¤ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±</div>
      <label>Ø§Ù„Ø¯Ù‚Ø© (9:16)</label>
      <select id="res">
        <option value="540x960">540Ã—960 â€” Ø³Ø±ÙŠØ¹</option>
        <option value="720x1280" selected>720Ã—1280 â€” Ù…ÙˆØµÙ‰ Ø¨Ù‡ âœ“</option>
        <option value="1080x1920">1080Ã—1920 â€” Ø¹Ø§Ù„ÙŠ</option>
      </select>
      <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª</label>
      <select id="fps"><option value="24">24 fps</option><option value="30" selected>30 fps âœ“</option></select>
    </div>
  </div>
</div>
<div>
  <div class="card" style="position:sticky;top:18px">
    <div class="ct">ğŸ“± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</div>
    <div class="phone">
      <div class="notch"></div>
      <div class="screen">
        <canvas id="pvc" width="270" height="480"></canvas>
        <div class="wvs"><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div><div class="wb"></div></div>
      </div>
    </div>
    <div class="pw" id="pw"><div class="pb" id="pb"></div></div>
    <div class="st" id="st"></div>
    <button class="btn-gen" id="btngen" onclick="generate()"><span id="bi">ğŸ¬</span><span id="bt">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„ØµÙˆØª</span></button>
    <button class="btn-s" onclick="doReset()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    <div class="dlb" id="dlb">
      <p id="dlmsg">âœ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø² Ø¨Ø§Ù„ØµÙˆØª!</p>
      <a id="dllink" href="#" class="btn-dl" download="quran_reel.webm">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
      <p class="share">Ø¥Ù†Ø³ØªØºØ±Ø§Ù… Â· ØªÙŠÙƒ ØªÙˆÙƒ Â· ÙŠÙˆØªÙŠÙˆØ¨ Shorts</p>
    </div>
    <div class="log" id="logbox"></div>
  </div>
</div>
</div>
</div>

<script>
const S={bgC1:'#0d2818',bgC2:'#061810',fx:'fade',edition:'ar.alafasy',ayahs:[],trArr:[],audioURLs:[],localNums:[],surahName:''};

// â”€â”€ Ø±Ø³Ù… Ø§Ù„Ø¥Ø·Ø§Ø± â”€â”€
const pvcEl=document.getElementById('pvc'),pctx=pvcEl.getContext('2d');
let pvIdx=0,pvT=0;

function drawFrame(c,W,H,ayah,tr,localNum,t){
  if(!ayah)return;
  const font=document.getElementById('fsel').value;
  const fs=parseInt(document.getElementById('fsize').value)*(W/540);
  const sBism=document.getElementById('bism').checked;
  const sRef=document.getElementById('ref').checked;
  const sPat=document.getElementById('pat').checked;
  const fx=S.fx;
  const g=c.createLinearGradient(0,0,0,H);g.addColorStop(0,S.bgC1);g.addColorStop(1,S.bgC2);c.fillStyle=g;c.fillRect(0,0,W,H);
  if(sPat){c.save();c.strokeStyle='rgba(201,168,76,0.07)';c.lineWidth=1.5;for(let r=80;r<Math.min(W,H);r+=120){c.beginPath();c.arc(W/2,H/2,r,0,Math.PI*2);c.stroke();}for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;c.beginPath();c.moveTo(W/2,H/2);c.lineTo(W/2+Math.cos(a)*W*1.5,H/2+Math.sin(a)*H*1.5);c.stroke();}c.restore();}
  let al=1,yo=0;
  if(fx==='fade') al=t<0.15?t/0.15:t>0.85?(1-t)/0.15:1;
  if(fx==='slide'){yo=50*(1-Math.min(t*3,1));al=Math.min(t*4,1);}
  if(fx==='glow') al=0.5+0.5*Math.sin(t*Math.PI*2);
  if(fx==='write') al=Math.min(t*2,1);
  if(fx==='zoom'){c.save();const sc=0.88+0.12*Math.min(t*3,1);c.translate(W/2,H/2);c.scale(sc,sc);c.translate(-W/2,-H/2);}
  if(fx==='flip'){c.save();c.translate(W/2,H/2);c.rotate(Math.sin(t*Math.PI)*0.06);c.translate(-W/2,-H/2);}
  c.globalAlpha=al;
  if(sBism){c.font=`${Math.round(fs*.44)}px 'Amiri',serif`;c.fillStyle='rgba(201,168,76,0.9)';c.textAlign='center';c.direction='rtl';c.fillText('Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù',W/2,H*.12+yo);}
  c.font=`${Math.round(fs*.92)}px '${font}',serif`;c.fillStyle='#fff';c.textAlign='center';c.direction='rtl';
  wrapTxt(c,ayah,W/2,H/2+yo,W*.85,fs*1.65);
  if(tr){c.font=`${Math.round(fs*.32)}px 'Tajawal',sans-serif`;c.fillStyle='rgba(200,193,168,0.82)';c.direction='ltr';wrapTxt(c,tr.substring(0,90),W/2,H/2+fs*2.8+yo,W*.88,fs*.86);}
  if(sRef&&S.surahName){c.font=`${Math.round(fs*.34)}px 'Tajawal',serif`;c.fillStyle='rgba(201,168,76,0.9)';c.direction='rtl';c.textAlign='center';c.fillText(`Ø³ÙˆØ±Ø© ${S.surahName}  Â·  Ø§Ù„Ø¢ÙŠØ© ${localNum}`,W/2,H*.88+yo);}
  if(fx==='zoom'||fx==='flip') c.restore();
  c.globalAlpha=1;
}
function wrapTxt(c,text,x,y,maxW,lh){
  if(!text)return;
  const words=text.split(' ');let line='';const lines=[];
  for(const w of words){const test=line?line+' '+w:w;if(c.measureText(test).width>maxW&&line){lines.push(line);line=w;}else line=test;}
  if(line)lines.push(line);const sy=y-(lines.length-1)*lh/2;lines.forEach((l,i)=>c.fillText(l,x,sy+i*lh));
}
setInterval(()=>{pvT=(pvT+0.012)%1;const txt=S.ayahs.length>0?S.ayahs[pvIdx%S.ayahs.length]:'Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù';const tr=S.trArr.length>0?S.trArr[pvIdx%S.trArr.length]:'';const num=S.localNums.length>0?S.localNums[pvIdx%S.localNums.length]:1;drawFrame(pctx,pvcEl.width,pvcEl.height,txt,tr,num,pvT);},50);
setInterval(()=>{if(S.ayahs.length>1)pvIdx=(pvIdx+1)%S.ayahs.length;},3000);

// â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ± â”€â”€
(async()=>{
  try{const r=await fetch('https://api.alquran.cloud/v1/surah');const d=await r.json();const sel=document.getElementById('surah');sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© â€”</option>';d.data.forEach(s=>{const o=document.createElement('option');o.value=s.number;o.textContent=`${s.number}. ${s.name} (${s.numberOfAyahs})`;sel.appendChild(o);});lg('âœ“ Ø§Ù„Ø³ÙˆØ±','ok');}catch(e){lg('! '+e.message,'er');}
})();

function onSurah(){S.ayahs=[];S.trArr=[];S.audioURLs=[];S.localNums=[];loadAyahs();}

async function loadAyahs(){
  const surah=document.getElementById('surah').value;
  const af=parseInt(document.getElementById('af').value)||1;
  const at=parseInt(document.getElementById('at').value)||af;
  const tr=document.getElementById('trans').value;
  if(!surah)return;
  setSt('ğŸ“¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª...');
  try{
    const r=await fetch(`https://api.alquran.cloud/v1/surah/${surah}/editions/quran-simple,${S.edition}`);
    const d=await r.json();
    if(d.code!==200)throw new Error(d.status);
    const arabEd=d.data[0],audioEd=d.data[1];
    S.surahName=arabEd.name;
    const filtered=arabEd.ayahs.filter(a=>a.numberInSurah>=af&&a.numberInSurah<=at);
    S.ayahs=filtered.map(a=>a.text);
    S.localNums=filtered.map(a=>a.numberInSurah);
    S.audioURLs=audioEd.ayahs.filter(a=>a.numberInSurah>=af&&a.numberInSurah<=at).map(a=>a.audio);
    document.getElementById('aytxt').value=S.ayahs.join('\n\n');
    pvIdx=0;setSt('âœ“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡');
    lg(`âœ“ ${S.ayahs.length} Ø¢ÙŠØ§Øª | ØµÙˆØª: ${S.audioURLs[0]}`,'ok');
    if(tr!=='none'){const r2=await fetch(`https://api.alquran.cloud/v1/surah/${surah}/${tr}`);const d2=await r2.json();S.trArr=d2.data.ayahs.filter(a=>a.numberInSurah>=af&&a.numberInSurah<=at).map(a=>a.text);}else S.trArr=[];
  }catch(e){lg('âœ— '+e.message,'er');setSt('âŒ');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ØµÙˆØª:
// 1. Ù†Ø´ØºÙ‘Ù„ Ø¹Ù†ØµØ± <audio> Ø¹Ø§Ø¯ÙŠ (Ø¨ÙŠØ´ØªØºÙ„ Ù…Ø¹Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„)
// 2. Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ù€ AudioContext Ø¹Ø¨Ø± createMediaElementSource
// 3. Ù†ØµØ¯Ù‘Ø± Ø§Ù„ØµÙˆØª ÙƒÙ€ MediaStream
// 4. Ù†Ø¯Ù…Ø¬Ù‡ Ù…Ø¹ Canvas stream ÙÙŠ MediaRecorder ÙˆØ§Ø­Ø¯
//
// Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ù„Ø£Ù†:
// - Ù„Ø§ ÙŠÙˆØ¬Ø¯ fetch Ø¥Ø¶Ø§ÙÙŠ (Ø§Ù„ØµÙˆØª ÙŠÙØ­Ù…ÙÙ‘Ù„ Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù†ØµØ± audio Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
// - AudioContext ÙŠÙ‚Ø¨Ù„ Ø£ÙŠ Ø¹Ù†ØµØ± audio ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generate(){
  if(!S.ayahs.length){alert('âš ï¸ Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© ÙˆØ¢ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹');return;}
  const btn=document.getElementById('btngen');
  btn.disabled=true;
  document.getElementById('bi').textContent='â³';
  document.getElementById('bt').textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
  document.getElementById('dlb').style.display='none';
  document.getElementById('pw').style.display='block';
  document.getElementById('logbox').style.display='block';

  try{
    const res=document.getElementById('res').value;
    const [W,H]=res.split('x').map(Number);
    const fps=parseInt(document.getElementById('fps').value);
    const dur=parseInt(document.getElementById('dur').value);
    const vol=parseInt(document.getElementById('vol').value)/100;

    // â”€â”€ Ø¥Ø¹Ø¯Ø§Ø¯ Canvas â”€â”€
    const rc=document.createElement('canvas');rc.width=W;rc.height=H;
    const rctx=rc.getContext('2d');
    const canvasStream=rc.captureStream(fps);
    lg(`ğŸ“¹ ${W}Ã—${H} @ ${fps}fps`,'in');

    // â”€â”€ AudioContext singleton (ÙŠÙ†Ø´Ø£ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) â”€â”€
    const aud=document.getElementById('aud');
    aud.volume=vol;
    if(!window._actx){
      const AudioCtx=window.AudioContext||window.webkitAudioContext;
      window._actx=new AudioCtx();
      window._audSrc=window._actx.createMediaElementSource(aud);
      window._gainNode=window._actx.createGain();
      window._audDest=window._actx.createMediaStreamDestination();
      window._audSrc.connect(window._gainNode);
      window._gainNode.connect(window._audDest);
      window._gainNode.connect(window._actx.destination);
      lg('âœ“ AudioContext Ø¬Ø¯ÙŠØ¯','ok');
    } else {
      window._gainNode.gain.value=vol;
      lg('âœ“ AudioContext Ù…ÙˆØ¬ÙˆØ¯','ok');
    }
    if(window._actx.state==='suspended') await window._actx.resume();
    // Ø£Ø¶Ù Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØª Ù„Ù„Ù€ canvas stream
    window._audDest.stream.getAudioTracks().forEach(t=>canvasStream.addTrack(t));
    lg('âœ“ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØª Ù…Ø¶Ø§Ù','ok');

    // â”€â”€ Ø¥Ø¹Ø¯Ø§Ø¯ MediaRecorder â”€â”€
    const mimes=['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4'];
    let mime='';for(const m of mimes){if(MediaRecorder.isTypeSupported(m)){mime=m;break;}}
    lg(`ğŸ“¼ ${mime||'webm'}`,'in');

    const recorder=new MediaRecorder(canvasStream,mime?{mimeType:mime,videoBitsPerSecond:5000000}:{});
    const chunks=[];
    recorder.ondataavailable=e=>{if(e.data&&e.data.size>0)chunks.push(e.data);};

    // â”€â”€ Ø´ØºÙ‘Ù„ Ø£ÙˆÙ„ Ø¢ÙŠØ© ÙˆØ§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„Ù‡Ø§ â”€â”€
    setSt('ğŸµ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ Ø¢ÙŠØ©...');
    aud.src=S.audioURLs[0];
    aud.load();
    await new Promise((resolve,reject)=>{
      aud.oncanplay=resolve;
      aud.onerror=()=>reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª'));
      setTimeout(resolve,5000); // timeout Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
    });
    lg('âœ“ Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø²','ok');

    // â”€â”€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØµÙˆØª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù„Ø­Ø¸Ø© â”€â”€
    if(actx.state==='suspended') await actx.resume();
    recorder.start(100);
    aud.play();
    lg('â–¶ Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ + Ø§Ù„ØµÙˆØª Ù…Ø¹Ø§Ù‹','ok');
    setP(5);

    // â”€â”€ Ù…Ø´ØºÙ‘Ù„ ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù„Ø¢ÙŠØ§Øª â”€â”€
    let currentAyah=0;
    aud.onended=async()=>{
      currentAyah++;
      if(currentAyah<S.audioURLs.length){
        aud.src=S.audioURLs[currentAyah];
        aud.load();
        await new Promise(res=>{aud.oncanplay=res;setTimeout(res,3000);});
        aud.play().catch(()=>{});
        lg(`â–¶ Ø¢ÙŠØ© ${S.localNums[currentAyah]}`,'ok');
      } else {
        // ÙƒØ±Ù‘Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        currentAyah=0;
        aud.src=S.audioURLs[0];
        aud.load();
        await new Promise(res=>{aud.oncanplay=res;setTimeout(res,3000);});
        aud.play().catch(()=>{});
      }
    };

    // â”€â”€ Ø­Ø±Ù‘Ùƒ Canvas â”€â”€
    setSt('ğŸ¬ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„ØµÙˆØª...');
    const startTime=performance.now();
    const fpa=dur/S.ayahs.length;

    await new Promise(resolve=>{
      function tick(now){
        const elapsed=(now-startTime)/1000;
        if(elapsed>=dur){resolve();return;}
        const ai=Math.min(Math.floor(elapsed/fpa),S.ayahs.length-1);
        if(S.ayahs[ai]){
          drawFrame(rctx,W,H,S.ayahs[ai],S.trArr[ai]||'',S.localNums[ai],(elapsed%fpa)/fpa);
        }
        setP(5+(elapsed/dur)*90);
        setSt(`ğŸ¬ ${Math.floor(elapsed)}/${dur}Ø«  |  Ø§Ù„Ø¢ÙŠØ© ${S.localNums[ai]||''}`);
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });

    // â”€â”€ Ø£ÙˆÙ‚Ù â”€â”€
    aud.pause();aud.src='';aud.onended=null;
    recorder.stop();
    // actx stays open (singleton)
    await new Promise(res=>{recorder.onstop=res;});
    setP(100);setSt('âœ… Ø§ÙƒØªÙ…Ù„!');

    const ext=mime.includes('mp4')?'mp4':'webm';
    const blob=new Blob(chunks,{type:mime||'video/webm'});
    const url=URL.createObjectURL(blob);
    const mb=(blob.size/1024/1024).toFixed(1);
    lg(`âœ… ${mb} MB â€” Ø¨Ø§Ù„ØµÙˆØª ğŸµ`,'ok');

    document.getElementById('dllink').href=url;
    document.getElementById('dllink').download=`quran_${S.surahName}_${Date.now()}.${ext}`;
    document.getElementById('dllink').textContent=`â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ ${ext.toUpperCase()} (${mb} MB)`;
    document.getElementById('dlmsg').textContent='âœ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø² Ø¨ØµÙˆØª Ø§Ù„ØªÙ„Ø§ÙˆØ© ğŸµ';
    document.getElementById('dlb').style.display='block';

  }catch(e){
    lg('âœ— '+e.message,'er');setSt('âŒ '+e.message.substring(0,60));
    console.error(e);
  }
  btn.disabled=false;document.getElementById('bi').textContent='ğŸ¬';document.getElementById('bt').textContent='Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯';
}

function doTab(n,el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tp').forEach(p=>p.classList.remove('active'));el.classList.add('active');document.getElementById('tp-'+n).classList.add('active');}
function doRng(el,id,sfx){document.getElementById(id).textContent=el.value+sfx;el.style.setProperty('--pct',((el.value-el.min)/(el.max-el.min)*100)+'%');}
function doPal(el,c1,c2){document.querySelectorAll('.col').forEach(o=>o.classList.remove('active'));el.classList.add('active');S.bgC1=c1;S.bgC2=c2;}
function doEff(el,e){document.querySelectorAll('.eff').forEach(o=>o.classList.remove('active'));el.classList.add('active');S.fx=e;}
function doRec(el,e){document.querySelectorAll('.rec').forEach(o=>o.classList.remove('active'));el.classList.add('active');S.edition=e;if(document.getElementById('surah').value)loadAyahs();}
function updFont(){document.getElementById('fpdemo').style.fontFamily=`'${document.getElementById('fsel').value}',serif`;}
function doReset(){S.ayahs=[];S.trArr=[];S.audioURLs=[];S.localNums=[];S.surahName='';document.getElementById('surah').value='';document.getElementById('aytxt').value='';document.getElementById('dlb').style.display='none';document.getElementById('pw').style.display='none';document.getElementById('logbox').innerHTML='';document.getElementById('logbox').style.display='none';setSt('');setP(0);}
function setP(p){document.getElementById('pb').style.width=Math.min(p,100)+'%';}
function setSt(m){document.getElementById('st').textContent=m;}
function lg(msg,type=''){const lb=document.getElementById('logbox');lb.style.display='block';const d=document.createElement('div');d.className=type;d.textContent='['+new Date().toLocaleTimeString('ar-EG')+'] '+msg;lb.appendChild(d);lb.scrollTop=lb.scrollHeight;}
</script>
</body>
</html>
